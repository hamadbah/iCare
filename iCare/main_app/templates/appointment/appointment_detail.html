{% extends 'base.html' %}
{% block content %}
{% load static %}

<h3 class="center-align" style="font-weight: bold;">Appointment Details</h3>
<div class="flex-container" style="display: flex; gap: 20px; flex-wrap: wrap;">
    <div class="card-content">
        <p style="font-weight: bold;"><strong>Name:</strong> {{ patient.patient_name }} - <strong>National ID:</strong>
            {{ patient.national_id }}
            - <strong>DOB:</strong> {{ patient.date_of_birth }} - <strong>Gender:</strong> {{ patient.gender|capfirst }}
            - <strong>Phone:</strong> {{ patient.phone }} </p>
        <hr />
        <p style="font-weight: bold;"><strong>Date:</strong> {{ appointment.appointment_date }} - <strong>Time:</strong>
            {{ appointment.appointment_time }} <strong>Doctor Code:</strong> {{ appointment.doctor_code }}
            - <strong>Visit Type:</strong> {{ appointment.visit_type|capfirst }} - <strong>Status:</strong> {{ appointment.status }}</p>
    </div>
    <div>
        <img src="{% static patient.image|cut:'main_app/static/' %}" alt="{{ patient.patient_name }}"
            style="max-width: 150px; height: 80px; border-radius: 8px;" />
    </div>

</div>
<div class="first" style="display: block; background: lightblue; padding: 10px; margin: 10px 0;">
    <a id="allergyBtn" href="#allergyModal" style="text-transform:none;"
        class="btn modal-trigger {% if patient.allergy_set.count %}red{% else %}grey darken-2{% endif %}">Allergies</a>
    <a id="allergyBtn" href="#alertModal" style="text-transform:none;"
        class="btn modal-trigger {% if patient.alert_set.count %}red{% else %}grey darken-2{% endif %}">Alerts</a>
    <a href="{% url 'detail' patient.id %}" class="btn grey darken-4" style="text-transform:none;">⬅ Back to Patient</a>
</div>
<div class="row" style="margin-top: 10px;">
    <div class="col s12">
        <ul class="tabs">
            <li class="tab col"><a href="#notes">Doctor Notes</a></li>
            <li class="tab col"><a href="#vitals">Vitals</a></li>
            <li class="tab col"><a href="#labs">Labs</a></li>
            <li class="tab col"><a href="#prescriptions">Prescriptions</a></li>
            <li class="tab col"><a href="#orders">Orders</a></li>
            <li class="tab col"><a href="#diagnosis">Diagnosis</a></li>
            <li class="tab col"><a href="#nursenote">Nurse Note</a></li>
        </ul>
    </div>
</div>
<div id="notes" class="col s12">
    {% if user.is_authenticated %}
    {% if user.profile.role == 'doctor' or user.profile.role == 'admin' %}
    <a id="notesBtn" class="btn green modal-trigger" href="#doctornoteModal" style="text-transform:none;">➕ Doctor
        Notes</a>
    {% endif %}
    {% endif %}
    <table class="striped highlight responsive-table">
        <thead>
            <tr>
                <th>Subjective</th>
                <th>Objective</th>
                <th>Plan</th>
                {% if user.is_authenticated %}
                {% if user.profile.role == 'doctor' %}
                <th>Edit</th>
                <th>Delete</th>
                {% endif %}
                {% endif %}
            </tr>
        </thead>
        <tbody>
            {% for notes in appointment.doctornote_set.all %}
            <tr>
                <td>{{ notes.subjective|default:"-" }}</td>
                <td>{{ notes.objective|default:"-" }}</td>
                <td>{{ notes.plan|default:"-" }}</td>
                {% if user.is_authenticated %}
                {% if user.profile.role == 'doctor' or user.profile.role == 'admin' %}
                <td><a href="{% url 'note-update' notes.id %}" class="btn white">✏️</a></td>
                <td><a href="{% url 'note-delete' notes.id %}" class="btn white">❌</a></td>
                {% endif %}
                {% endif %}
            </tr>
            {% empty %}
            <tr>
                <td colspan="5">No notes recorded yet</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
<div id="vitals" class="col s12">
    <a id="vitalsBtn" class="btn green modal-trigger" href="#vitalModal" style="text-transform:none;">➕ Vitals</a>
    <table class="striped highlight responsive-table">
        <thead>
            <tr>
                <th>Temperature</th>
                <th>Heart Rate</th>
                <th>Respiratory Rate</th>
                <th>Blood Pressure</th>
                <th>O₂ Saturation</th>
                <th>Edit</th>
                <th>Delete</th>
            </tr>
        </thead>
        <tbody>
            {% for vitals in appointment.vitalsign_set.all %}
            <tr>
                <td>{{ vitals.temperature|default:"-" }} °C</td>
                <td>{{ vitals.heart_rate|default:"-" }} bpm</td>
                <td>{{ vitals.respiratory_rate|default:"-" }} /min</td>
                <td>
                    {% if vitals.systolic_bp and vitals.diastolic_bp %}
                    {{ vitals.systolic_bp }}/{{ vitals.diastolic_bp }} mmHg
                    {% else %}
                    -
                    {% endif %}
                </td>
                <td>{{ vitals.oxygen_saturation|default:"-" }} %</td>
                <td><a href="{% url 'vital-update' vitals.id %}" class="btn white">✏️</a></td>
                <td><a href="{% url 'vital-delete' vitals.id %}" class="btn white">❌</a></td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="7">No vitals recorded yet</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
<div id="labs" class="col s12">
    <a id="labBtn" class="btn green modal-trigger" href="#labModal" style="text-transform:none;">➕ Labs</a>
    <table class="striped highlight responsive-table">
        <thead>
            <tr>
                <th>Test Name</th>
                <th>Date</th>
                <th>Result</th>
                <th>Status</th>
                <th>Edit</th>
                <th>Delete</th>
            </tr>
        </thead>
        <tbody>
            {% for labs in appointment.lab_set.all %}
            <tr>
                <td>{{ labs.test_name|default:"-" }}</td>
                <td>{{ labs.test_date|default:"-" }}</td>
                <td>{{ labs.result|default:"-" }}</td>
                <td>{{ labs.lab_status|default:"-" }}</td>
                <td><a href="{% url 'lab-update' labs.id %}" class="btn white">✏️</a></td>
                <td><a href="{% url 'lab-delete' labs.id %}" class="btn white">❌</a></td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="6">No labs requested yet</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
<div id="prescriptions" class="col s12">
    {% if user.is_authenticated %}
    {% if user.profile.role == 'doctor' or user.profile.role == 'admin' %}
    <a id="prescriptionBtn" class="btn green modal-trigger" href="#prescriptionModal" style="text-transform:none;">➕
        Prescriptions</a>
    {% endif %}
    {% endif %}
    <table class="striped highlight responsive-table">
        <thead>
            <tr>
                <th>Drug Name</th>
                <th>Dosage</th>
                <th>Frequency</th>
                <th>Duration</th>
                {% if user.is_authenticated %}
                {% if user.profile.role == 'doctor' or user.profile.role == 'admin' %}
                <th>Edit</th>
                <th>Delete</th>
                {% endif %}
                {% endif %}
            </tr>
        </thead>
        <tbody>
            {% for prescriptions in appointment.prescription_set.all %}
            <tr>
                <td>{{ prescriptions.drug_name|default:"-" }}</td>
                <td>{{ prescriptions.dosage|default:"-" }}</td>
                <td>{{ prescriptions.frequency|default:"-" }}</td>
                <td>{{ prescriptions.duration|default:"-" }}</td>
                {% if user.is_authenticated %}
                {% if user.profile.role == 'doctor' or user.profile.role == 'admin' %}
                <td><a href="{% url 'prescription-update' prescriptions.id %}" class="btn white">✏️</a></td>
                <td><a href="{% url 'prescription-delete' prescriptions.id %}" class="btn white">❌</a></td>
                {% endif %}
                {% endif %}
            </tr>
            {% empty %}
            <tr>
                <td colspan="6">No drug prescribed yet</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div id="orders" class="col s12">
    {% if user.is_authenticated %}
    {% if user.profile.role == 'doctor' or user.profile.role == 'admin' %}
    <a id="ordersBtn" class="btn green modal-trigger" href="#ordersModal" style="text-transform:none;">➕ Orders</a>
    {% endif %}
    {% endif %}
    <table class="striped highlight responsive-table">
        <thead>
            <tr>
                <th>Order Date</th>
                <th>Order Type</th>
                <th>Instructions</th>
                <th>Priority</th>
                <th>Status</th>
                {% if user.is_authenticated %}
                {% if user.profile.role == 'doctor' or user.profile.role == 'admin' %}
                <th>Edit</th>
                <th>Delete</th>
                {% endif %}
                {% endif %}
            </tr>
        </thead>
        <tbody>
            {% for orders in appointment.doctororder_set.all %}
            <tr>
                <td>{{ orders.order_date|default:"-" }}</td>
                <td>{{ orders.order_type|default:"-" }}</td>
                <td>{{ orders.instructions|default:"-" }}</td>
                <td>{{ orders.priority|default:"-" }}</td>
                <td>{{ orders.order_status|default:"-" }}</td>
                {% if user.is_authenticated %}
                {% if user.profile.role == 'doctor' or user.profile.role == 'admin' %}
                <td><a href="{% url 'order-update' orders.id %}" class="btn white">✏️</a></td>
                <td><a href="{% url 'order-delete' orders.id %}" class="btn white">❌</a></td>
                {% endif %}
                {% endif %}
            </tr>
            {% empty %}
            <tr>
                <td colspan="6">No orders yet</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>


<div id="diagnosis" class="col s12">
    {% if user.is_authenticated %}
    {% if user.profile.role == 'doctor' or user.profile.role == 'admin' %}
    <a id="diagnosisBtn" class="btn green modal-trigger" href="#diagnosisModal" style="text-transform:none;">➕
        Diagnosis</a>
    {% endif %}
    {% endif %}
    <table class="striped highlight responsive-table">
        <thead>
            <tr>
                <th>Diagnosis Name</th>
                <th>Date</th>
                <th>Status</th>
                {% if user.is_authenticated %}
                {% if user.profile.role == 'doctor' or user.profile.role == 'admin' %}
                <th>Edit</th>
                <th>Delete</th>
                {% endif %}
                {% endif %}
            </tr>
        </thead>
        <tbody>
            {% for diagnosis in appointment.diagnosis_set.all %}
            <tr>
                <td>{{ diagnosis.diagnosis_name|default:"-" }}</td>
                <td>{{ diagnosis.diagnosis_date|default:"-" }}</td>
                <td>{{ diagnosis.diagnosis_status|default:"-" }}</td>
                <td><a href="{% url 'diagnosis-update' diagnosis.id %}" class="btn white">✏️</a></td>
                <td><a href="{% url 'diagnosis-delete' diagnosis.id %}" class="btn white">❌</a></td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="6">No diagnosis yet</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div id="nursenote" class="col s12">
    {% if user.is_authenticated %}
    {% if user.profile.role == 'nurse' or user.profile.role == 'admin' %}
    <a id="nsnoteBtn" class="btn green modal-trigger" href="#nursenoteModal" style="text-transform:none;">➕ Nurse
        Note</a>
    {% endif %}
    {% endif %}
    <table class="striped highlight responsive-table">
        <thead>
            <tr>
                <th>Time</th>
                <th>Note</th>
                {% if user.is_authenticated %}
                {% if user.profile.role == 'nurse' or user.profile.role == 'admin' %}
                <th>Edit</th>
                <th>Delete</th>
                {% endif %}
                {% endif %}
            </tr>
        </thead>
        <tbody>
            {% for nursenote in appointment.nursenote_set.all %}
            <tr>
                <td>{{ nursenote.note_time|default:"-" }}</td>
                <td>{{ nursenote.note|default:"-" }}</td>
                <td><a href="{% url 'nurse-note-update' nursenote.id %}" class="btn white">✏️</a></td>
                <td><a href="{% url 'nurse-note-delete' nursenote.id %}" class="btn white">❌</a></td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="6">No notes yet</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div id="vitalModal" class="modal">
    <div class="modal-content">
        <h4>Add Vital Sign</h4>
        <form id="vitalForm" action="{% url 'add-vitals' appointment.id %}" method="post">
            {% csrf_token %}
            {{ vitalsign_form.as_p }}
            <div class="modal-footer" style="margin-top:15px;">
                <button type="submit" class="btn blue" style="text-transform:none;">Save</button>
                <a href="#!" class="modal-close btn grey" style="text-transform:none;">Cancel</a>
            </div>
        </form>
    </div>
</div>
<div id="doctornoteModal" class="modal">
    <div class="modal-content">
        <h4>Add Doctor Note</h4>
        <form id="doctornoteForm" action="{% url 'add_notes' appointment.id %}" method="post">
            {% csrf_token %}
            {{ doctornote_form.as_p }}
            <div class="modal-footer" style="margin-top:15px;">
                <button type="submit" class="btn blue" style="text-transform:none;">Save</button>
                <a href="#!" class="modal-close btn grey" style="text-transform:none;">Cancel</a>
            </div>
        </form>
    </div>
</div>
<div id="prescriptionModal" class="modal">
    <div class="modal-content">
        <h4>Add Prescription</h4>
        <form id="prescriptionForm" action="{% url 'add_prescriptions' appointment.id %}" method="post">
            {% csrf_token %}
            {{ prescription_form.as_p }}
            <div class="modal-footer" style="margin-top:15px;">
                <button type="submit" class="btn blue" style="text-transform:none;">Save</button>
                <a href="#!" class="modal-close btn grey" style="text-transform:none;">Cancel</a>
            </div>
        </form>
    </div>
</div>

<div id="ordersModal" class="modal">
    <div class="modal-content">
        <h4>Add Order</h4>
        <form id="doctororderForm" action="{% url 'add_order' appointment.id %}" method="post">
            {% csrf_token %}
            {{ doctororder_form.as_p }}
            <div class="modal-footer" style="margin-top:15px;">
                <button type="submit" class="btn blue" style="text-transform:none;">Save</button>
                <a href="#!" class="modal-close btn grey" style="text-transform:none;">Cancel</a>
            </div>
        </form>
    </div>
</div>

<div id="labModal" class="modal">
    <div class="modal-content">
        <h4>Add Lab</h4>
        <form id="labForm" action="{% url 'add_lab' appointment.id %}" method="post">
            {% csrf_token %}
            {{ lab_form.as_p }}
            <div class="modal-footer" style="margin-top:15px;">
                <button type="submit" class="btn blue" style="text-transform:none;">Save</button>
                <a href="#!" class="modal-close btn grey" style="text-transform:none;">Cancel</a>
            </div>
        </form>
    </div>
</div>
<div id="diagnosisModal" class="modal">
    <div class="modal-content">
        <h4>Add Diagnosis</h4>
        <form id="diagnosisForm" action="{% url 'add_diagnosis' appointment.id %}" method="post">
            {% csrf_token %}
            {{ diagnosis_form.as_p }}
            <div class="modal-footer" style="margin-top:15px;">
                <button type="submit" class="btn blue" style="text-transform:none;">Save</button>
                <a href="#!" class="modal-close btn grey" style="text-transform:none;">Cancel</a>
            </div>
        </form>
    </div>
</div>

<div id="nursenoteModal" class="modal">
    <div class="modal-content">
        <h4>Add Nurse Note</h4>
        <form id="nursenoteForm" action="{% url 'add_nurse_note' appointment.id %}" method="post">
            {% csrf_token %}
            {{ nursenote_form.as_p }}
            <div class="modal-footer" style="margin-top:15px;">
                <button type="submit" class="btn blue" style="text-transform:none;">Save</button>
                <a href="#!" class="modal-close btn grey" style="text-transform:none;">Cancel</a>
            </div>
        </form>
    </div>
</div>

<div id="allergyModal" class="modal">
    <div class="modal-content">
        <h4>Allergies Details</h4>
        {% if patient.allergy_set.all %}
        <table class="striped highlight responsive-table">
            <thead>
                <tr>
                    <th>Allergy Name</th>
                    <th>Severity</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for allergy in patient.allergy_set.all %}
                <tr>
                    <td>{{ allergy.allergy_name|default:"-"|capfirst }}</td>
                    <td>{{ allergy.severity|default:"-"|capfirst }}</td>
                    <td>{{ allergy.allergy_status|default:"-"|capfirst }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p>No allergies recorded for this patient.</p>
        {% endif %}
    </div>
    <div class="modal-footer">
        <a href="#!" class="modal-close btn grey">Close</a>
    </div>
</div>

<div id="alertModal" class="modal">
    <div class="modal-content">
        <h4>Alerts Details</h4>
        {% if patient.alert_set.all %}
        <table class="striped highlight responsive-table">
            <thead>
                <tr>
                    <th>Alert Name</th>
                    <th>Status</th>
                    <th>Note</th>
                </tr>
            </thead>
            <tbody>
                {% for alert in patient.alert_set.all %}
                <tr>
                    <td>{{ alert.infection_type|default:"-"|capfirst }}</td>
                    <td>{{ alert.alert_status|default:"-"|capfirst }}</td>
                    <td>{{ alert.alert_note|default:"-" }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p>No alerts recorded for this patient.</p>
        {% endif %}
    </div>
    <div class="modal-footer">
        <a href="#!" class="modal-close btn grey">Close</a>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        var elems = document.querySelectorAll('.modal');
        M.Modal.init(elems);

        var tabs = document.querySelectorAll('.tabs');
        M.Tabs.init(tabs);

        var dateEl = document.getElementById('id_test_date');
        if (dateEl) {
            M.Datepicker.init(dateEl, { format: 'yyyy-mm-dd', autoClose: true });
        }

        let selectEl = document.getElementById('id_lab_status');
        if (selectEl) {
            M.FormSelect.init(selectEl);
        }

        let priorityselectEl = document.getElementById('id_priority');
        if (priorityselectEl) {
            M.FormSelect.init(priorityselectEl);
        }

        var orderdateEl = document.getElementById('id_order_date');
        if (orderdateEl) {
            M.Datepicker.init(orderdateEl, { format: 'yyyy-mm-dd', autoClose: true });
        }

        let orderstatusEl = document.getElementById('id_order_status');
        if (orderstatusEl) {
            M.FormSelect.init(orderstatusEl);
        }

        var diagDateEl = document.getElementById('id_diagnosis_date');
        if (diagDateEl) {
            M.Datepicker.init(diagDateEl, { format: 'yyyy-mm-dd', autoClose: true });
        }

        let diagSelectEl = document.getElementById('id_diagnosis_status');
        if (diagSelectEl) {
            M.FormSelect.init(diagSelectEl);
        }
        var notetimeEl = document.getElementById('id_note_time');
        if (notetimeEl) {
            M.Timepicker.init(notetimeEl, {
                twelveHour: false,
                defaultTime: 'now',
                autoClose: true,
                vibrate: true
            });
        }
        const appointmentDate = new Date("{{ appointment.appointment_date|date:'Y-m-d' }}");
        const today = new Date();
        appointmentDate.setHours(0, 0, 0, 0);
        today.setHours(0, 0, 0, 0);

        const buttons = {
            vitalbtn: document.getElementById('vitalsBtn'),
            notebtn: document.getElementById('notesBtn'),
            labsbtn: document.getElementById('labBtn'),
            prescriptionsbtn: document.getElementById('prescriptionBtn'),
            orderbtn: document.getElementById('ordersBtn'),
            diagnosbtn: document.getElementById('diagnosisBtn'),
            nursenotebtn: document.getElementById('nsnoteBtn')
        };

        const disableButton = (btn, message) => {
            if (!btn) return;
            btn.classList.remove('modal-trigger');
            btn.removeAttribute('href');
            btn.style.pointerEvents = "auto";
            btn.addEventListener('click', function (e) {
                e.preventDefault();
                M.toast({ html: message, classes: 'rounded red' });
            });
        };

        if (appointmentDate.getTime() !== today.getTime()) {
            disableButton(buttons.vitalbtn, 'Vitals can only be added on todays appointment.');
            disableButton(buttons.notebtn, 'Doctor Notes can only be added on todays appointment.');
            disableButton(buttons.labsbtn, 'Labs can only be added on todays appointment.');
            disableButton(buttons.prescriptionsbtn, 'Prescriptions can only be added on todays appointment.');
            disableButton(buttons.orderbtn, 'Orders can only be added on todays appointment.');
            disableButton(buttons.diagnosbtn, 'Diagnosis can only be added on todays appointment.');
            disableButton(buttons.nursenotebtn, 'Nurse Notes can only be added on todays appointment.');
        }
    });
</script>
{% endblock %}