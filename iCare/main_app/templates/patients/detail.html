{% extends 'base.html' %}
{% load static %}
{% block content %}

<h3 style="font-weight: bolder;">Patient Details</h3>
<div class="card">
    <div class="flex-container" style="display: flex; gap: 20px; flex-wrap: wrap;">
        <div class="card-content">
            <p style="font-weight: bold;">
                <strong>Name:</strong> {{ patient.patient_name }} -
                <strong>National ID:</strong> {{ patient.national_id }} -
                <strong>DOB:</strong> {{ patient.date_of_birth }}
            </p>
            <p style="font-weight: bold;">
                <strong>Gender:</strong> {{ patient.gender|capfirst }} -
                <strong>Phone:</strong> {{ patient.phone }}
            </p>
        </div>
        <div>
            <img src="{% static patient.image|cut:'main_app/static/' %}" alt="{{ patient.patient_name }}"
                style="max-width: 150px; height: 80px; border-radius: 8px;" />
        </div>
    </div>
    <div class="card-action">
        {% if user.is_authenticated %}
        {% if user.profile.role == 'admin' %}
        <a href="{% url 'patient_delete' patient.id %}" class="btn red" style="text-transform:none;">Delete</a>
        {% endif %}
        {% if user.profile.role == 'admin' or user.profile.role == 'clerk' %}
        <a href="{% url 'patient_update' patient.id %}" class="btn blue" style="text-transform:none;">Edit</a>
        <a href="{% url 'index' %}" class="btn grey" style="text-transform:none;">Back</a>
        <a class="btn modal-trigger" href="#appointmentModal" style="text-transform:none;">Add Appointment</a>
        {% endif %}
        {% if user.profile.role == 'admin' or user.profile.role == 'doctor' or user.profile.role == 'nurse' %}
        <a href="{% url 'patient_summary' patient.id %}" class="btn blue" style="text-transform:none;">View Patient
            Summary</a>
        <a class="btn orange modal-trigger" href="#alertModal" style="text-transform:none;">Add Alert</a>
        <a class="btn orange modal-trigger" href="#allergyModal" style="text-transform:none;">Add Allergy</a>
        {% endif %}
        {% endif %}
    </div>
</div>

<div class="card" style="max-height: 300px; overflow-y: auto; margin-top:20px;">
    <h5 style="font-weight:bold; margin-left:10px; color: green;">Appointments</h5>
    <table class="striped">
        <thead>
            <tr>
                <th>Date</th>
                <th>Time</th>
                <th>Doctor Name</th>
                <th>Visit Type</th>
                <th>Status</th>
                {% if user.is_authenticated %}
                {% if user.profile.role == 'admin' or user.profile.role == 'doctor' or user.profile.role == 'nurse' %}
                <th>View</th>
                {% endif %}
                {% if user.profile.role == 'admin' or user.profile.role == 'clerk' %}
                <th>Edit</th>
                <th>Delete</th>
                {% endif %}
                {% endif %}
            </tr>
        </thead>
        <tbody>
            {% for appointment in appointments %}
            <tr>
                <td>{{ appointment.appointment_date }}</td>
                <td>{{ appointment.appointment_time }}</td>
                <td>{{ appointment.doctor_code }}</td>
                <td>{{ appointment.visit_type }}</td>
                <td>{{ appointment.status }}</td>
                {% if user.is_authenticated %}
                {% if user.profile.role == 'admin' or user.profile.role == 'doctor' or user.profile.role == 'nurse' %}
                <td>
                    <a href="{% url 'appointment_detail' appointment.id %}" class="btn white">➡️</a>
                </td>
                {% endif %}
                {% if user.profile.role == 'admin' or user.profile.role == 'clerk' %}
                <td>
                    <a href="{% url 'appointment-update' appointment.id %}" class="btn white">✏️</a>
                </td>
                <td>
                    <a href="{% url 'appointment-delete' appointment.id %}" class="btn white">❌</a>
                </td>
                {% endif %}
                {% endif %}
            </tr>
            {% empty %}
            <tr>
                <td colspan="6">No Appointments yet</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
<div style="display: flex; gap: 20px; margin-top:20px; flex-wrap: wrap;">
    <div class="card" style="flex: 1; max-height: 300px; overflow-y: auto;">
        <h5 style="font-weight:bold; margin-left:10px; color: red;">Alerts</h5>
        <div style="padding:10px;">
            <table class="striped highlight responsive-table">
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>Status</th>
                        <th>Note</th>
                        {% if user.is_authenticated %}
                        {% if user.profile.role == 'admin' or user.profile.role == 'doctor' or user.profile.role == 'nurse' %}
                        <th>Edit</th>
                        <th>Delete</th>
                        {% endif %}
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                    {% for alert in patient.alert_set.all %}
                    <tr>
                        <td>{{ alert.infection_type|default:"-" }}</td>
                        <td>{{ alert.alert_status|default:"-" }}</td>
                        <td>{{ alert.alert_note|default:"-" }}</td>
                        {% if user.is_authenticated %}
                        {% if user.profile.role == 'admin' or user.profile.role == 'doctor' or user.profile.role == 'nurse' %}
                        <td><a href="{% url 'alert_update' alert.id %}" class="btn white">✏️</a></td>
                        <td><a href="{% url 'alert_delete' alert.id %}" class="btn white">❌</a></td>
                        {% endif %}
                        {% endif %}
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7">No alerts for this patient.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="card" style="flex: 1; max-height: 300px; overflow-y: auto;">
        <h5 style="font-weight:bold; margin-left:10px; color: red;">Allergies</h5>
        <div style="padding:10px;">
            <table class="striped highlight responsive-table">
                <thead>
                    <tr>
                        <th>Allergy Name</th>
                        <th>Severity</th>
                        <th>Status</th>
                        {% if user.is_authenticated %}
                        {% if user.profile.role == 'admin' or user.profile.role == 'doctor' or user.profile.role == 'nurse' %}
                        <th>Edit</th>
                        <th>Delete</th>
                        {% endif %}
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                    {% for allergy in patient.allergy_set.all %}
                    <tr>
                        <td>{{ allergy.allergy_name|default:"-" }}</td>
                        <td>{{ allergy.severity|default:"-" }}</td>
                        <td>{{ allergy.allergy_status|default:"-" }}</td>
                        {% if user.is_authenticated %}
                        {% if user.profile.role == 'admin' or user.profile.role == 'doctor' or user.profile.role == 'nurse' %}
                        <td><a href="{% url 'allergy_update' allergy.id %}" class="btn white">✏️</a></td>
                        <td><a href="{% url 'allergy_delete' allergy.id %}" class="btn white">❌</a></td>
                        {% endif %}
                        {% endif %}
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7">No allergies for this patient.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
<div id="appointmentModal" class="modal">
    <div class="modal-content">
        <h4>Add Appointment</h4>
        <form id="appointmentForm" action="{% url 'add_appointment' patient.id %}" method="post">
            {% csrf_token %}
            {{ appointment_form.as_p }}
            <div class="modal-footer" style="margin-top:15px;">
                <button type="submit" class="btn blue" style="text-transform:none;">Book Appointment</button>
                <a href="#!" class="modal-close btn grey" style="text-transform:none;">Cancel</a>
            </div>
        </form>
    </div>
</div>

<div id="alertModal" class="modal">
    <div class="modal-content">
        <h4>Add Alert</h4>
        <form id="alertForm" action="{% url 'add_alert' patient.id %}" method="post">
            {% csrf_token %}
            {{ alert_form.as_p }}
            <div class="modal-footer" style="margin-top:15px;">
                <button type="submit" class="btn blue" style="text-transform:none;">Save</button>
                <a href="#!" class="modal-close btn grey" style="text-transform:none;">Cancel</a>
            </div>
        </form>
    </div>
</div>

<div id="allergyModal" class="modal">
    <div class="modal-content">
        <h4>Add Allergy</h4>
        <form id="allergyForm" action="{% url 'add_allergy' patient.id %}" method="post">
            {% csrf_token %}
            {{ allergy_form.as_p }}
            <div class="modal-footer" style="margin-top:15px;">
                <button type="submit" class="btn blue" style="text-transform:none;">Save</button>
                <a href="#!" class="modal-close btn grey" style="text-transform:none;">Cancel</a>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        var modalElems = document.querySelectorAll('.modal');
        M.Modal.init(modalElems);

        var dateEl = document.getElementById('id_appointment_date');
        if (dateEl) {
            M.Datepicker.init(dateEl, {
                format: 'yyyy-mm-dd',
                defaultDate: new Date(),
                setDefaultDate: true,
                autoClose: true
            });
        }

        var timeEl = document.getElementById('id_appointment_time');
        if (timeEl) {
            M.Timepicker.init(timeEl, {
                twelveHour: false,
                defaultTime: 'now',
                autoClose: true,
                vibrate: true
            });
        }

        var selects = document.querySelectorAll('select');
        M.FormSelect.init(selects);
    });
</script>

{% endblock %}